package com.framework.utils.filters
{
	import com.framework.utils.loader.HttpLoader;
	
	import flash.display.Loader;
	import flash.display.LoaderInfo;
	import flash.display.Sprite;
	import flash.events.Event;
	import flash.net.URLRequestMethod;
	import flash.net.URLVariables;
	import flash.utils.ByteArray;
	
	/**
	 * httpjson 接口安全过滤器
	 * 
	 * @author 任冬 rendong@corp.the9.com
	 * $Id: HttpJsonSFilter.as 464 2010-11-08 12:48:58Z rendong $
	 * @version 1.0
	 */
	public class HttpJsonSFilter
	{
		/**
		 * 加密使用的swf 
		 */		
		private var sp:Sprite;
		/**
		 * 初始化的ticket 
		 */		
		private var t:int=0;
		
		/**
		 * 签名使用的uid 
		 */		
		private var uid:String;
		
		/**
		 * 加载成功后的回调函数 
		 */		
		private var callback:Function;
		
		/**
		 * swf二进制 
		 */		
		private var bytes:ByteArray;
		
		public function HttpJsonSFilter()
		{
			// 加密用的swf  对应encrypt_unzip_p1.swf 去掉头3个字节
			var code:String = '0A86170000780004E200000EA600001801004411190000007F13C80100003C7264663A52444620786D6C6E733A7264663D27687474703A2F2F7777772E77332E6F72672F313939392F30322F32322D7264662D73796E7461782D6E7323273E3C7264663A4465736372697074696F6E207264663A61626F75743D272720786D6C6E733A64633D27687474703A2F2F7075726C2E6F72672F64632F656C656D656E74732F312E31273E3C64633A666F726D61743E6170706C69636174696F6E2F782D73686F636B776176652D666C6173683C2F64633A666F726D61743E3C64633A7469746C653E41646F626520466C65782034204170706C69636174696F6E3C2F64633A7469746C653E3C64633A6465736372697074696F6E3E687474703A2F2F7777772E61646F62652E636F6D2F70726F64756374732F666C65783C2F64633A6465736372697074696F6E3E3C64633A7075626C69736865723E756E6B6E6F776E3C2F64633A7075626C69736865723E3C64633A63726561746F723E756E6B6E6F776E3C2F64633A63726561746F723E3C64633A6C616E67756167653E454E3C2F64633A6C616E67756167653E3C64633A646174653E323031302D31312D383C2F64633A646174653E3C2F7264663A4465736372697074696F6E3E3C2F7264663A5244463E004410E8033C004302FFFFFF5A0A030000000600000004004F37000000000000BC3B872A2C010000C80A5F5F5F5F5F5F5F00BF1454150000010000006672616D65310010002E0019001081C694BA06F6A8C98101DBE181A102AA8C9FBC04D8B182CC06A2A2C0DC06A190D0CD04D1B4F9B202D3A89012E69B878F02EDA9E8AA04D985BCBB06A2C2F5EC06A99FFBDE04C6FDEDC40285BAA024F8F989FD0197FFAB9904C3B3EDAA06CFFCA1FD06A1A3A0F004BBA5DFD602002F00002071B5F9ED410000C09F5B17E3410000008F54EDEA410000C0EAF618ED410000C0DDB937E8410000E0F581AFEE41000060C20806E541000020A0D2A8EF410000E0F59E68E14100002076EBFFEF410000C0F79A2BE141000060320EB3EF410000C07128CFE441000040ACC4C3EE41000000681608E841000040F5D836ED410000A00BE2C5EA41000020D03C14EB41000000797FFAEC410000C0FAE066E8410000E0B0A19AEE410000A0207D3CE5410000007FF49DEF410000409149A5E1410000402847FFEF41000020D03EEEE04100008001A7BCEF4100008048DD97E4410000006C69D7EE410000008EF7D7E741000040FF2454ED410000A010E69DEA41000020079A3AEB410000A03C73DBEC410000A0CC8A95E841000080482485EE410000E0748472E541000020077492EF410000409299E1E1410000A08FFEFDEF41000020BA8BB0E041000000DC9CC5EF41000080622860E441000040D06FEAEE410000A0465EA7E74100002072DA70ED414D0006537472696E6704766F69640B666C6173682E7574696C730942797465417272617907426F6F6C65616E0475696E74054172726179075F5F5F5F5F5F5F0D666C6173682E646973706C617906537072697465055F5F5F5F5F065F5F5F5F5F5F075F5F5F5F5F5F5F0D5F5F5F5F5F5F5F5F5F5F5F5F5F03696E740D402324255E2628295F2B5D7D3E0B2140252628292B3D5D7D3C105F5F5F5F5F5F5F5F5F5F5F5F5F5F5F5F102D29282E3E21605B3C5E7D2E7E5F253D03602D3F064F626A656374142D29282E3E21605B3C5E7D2E7E5F253D3A602D3F17235E7E2E5D5B263E2A3C602E2B212D7D29242E283F407B054023252B3E1D235E7E2E5D5B263E2A3C602E2B212D7D29242E283F407B3A4023252B3E08746F537472696E670B232628292B3D5D7B5B3F7E0C24255E262A285F7B7D5B3E7E0426297D3C03217B3C1B235E7E2E5D5B263E2A3C602E2B212D7D29242E283F407B3A217B3C022D3E022A2803213E3C022B3E03217B5B022660087B3D3C29605F2D5D0A252A263E603D3F7E5D2D072140252D2B5B7E0940255E292D3D5D5B3E0940235E282D3D5D5B3F21687474703A2F2F61646F62652E636F6D2F4153332F323030362F6275696C74696E0C66726F6D43686172436F6465012C0230780A63686172436F64654174066C656E6774680573706C6974056170706C7905747261636505657175616C067375627374720C666C6173682E6576656E74730F4576656E74446973706174636865720D446973706C61794F626A65637411496E7465726163746976654F626A65637416446973706C61794F626A656374436F6E7461696E657206526567457870045C737C3A02676D077265706C6163650130087061727365496E74013A0C7265616455544642797465730D7772697465555446427974657306656E6469616E08706F736974696F6E06456E6469616E0D4C4954544C455F454E4449414E0F72656164556E7369676E6564496E740470757368107772697465556E7369676E6564496E74037368611416011604160A1809161418171618081A18200500082C1637050017141A171A16050017181A20060107060D010E060F10090D010B0E060F1011050105070A0112091310084607010207010307020507010607010707010807010907030B07010C07010D07010E07010F07011007011107011207011307051507011607071907081B07081C07081D07081E07071F091901070A21070A22070A2307011C070A24070A2507011B07011D070A2607011E070A2707012807012907012A07012B070B2D070B30070B1B070131070B32070B33070134070B36070C3807033907033A07033B07013C070B3F0701411B02091B030701430701440915040701451B05070146070247070148070149070B4A07014B091F0122000000000000000001010100000102010000010101000000000000000000000103010000020103040008010A0A0101010000020101040008010A0A00000000000000000000000000050000000500000103030000000100000000000000000000000000000005000000050000010303000002060605000002050505000006050505050505050000070505050505050505000007050505050505050500000705050505050505050000070505050505050505000000010000000000000000000000040708090400010709000001000A000001000B000001000C00000D01030E0100020F0100031001000411120906000B00130005001204140100111501000F1601000E17010010181209090119200B1A01001B1B01001D1C01001A1D0100161E01001E1F0100192001001F210100152201001C2301001724010018000006042511060A2011050926110307271104080D0014012806010D0203040501070401000C01110400011301130400022101180400031D000101080903D030470000010301090A24D030D06001245F4629016809D060012474462901680AD060012473462901680BD04900470000020404090A23D0305D184A18008018D6D260116011D14625014626014623018003D76011D3462701480000030504090A50D0302C01D62400D71020000009D22C0113050000D22C2EA0D6D22C2FD1D3462A012410462B01A0A085D6C203D3D1662C15D8FFFFD16001662920D22C2E462D01462E02140800005D2F2C35D24F2F02470000042E09090AC801D0306001247124732463243D2A2A247724732478242D2A2A245E2A245F245E2A2428245F2A2429245B242A246E24622475242A245D247B24402A2A247D2470246C246D242D2A2A246F246B246E243D2A2A46292D85D65D184A18008018D7D360116011D1D2A046250146260146230180036304601162044627018563056011D3601160116205D0660C240A462B01A0462501462601462301462701856306D02A6307660CC0630862076208610C080808076205240024044630026206A0620524082404463002A0480000050201010823D0306500601230603130603230603330603430600830600858001D1D1D1D1D1D6807470000060101030403D030470000070604030462D030208003D6240074D7D160352C3D2C3E42022C0146360285D55D034A03008003D6D1662C24012AABA8120600002C40D1A085D5240074D7101C000009D2D32402A35D37D1D3240246300224104637026138D32402A074D7D3D1662C15DCFFFFD2480000080405030454D0302085D724007463042C01D724007463041033000009D32C40D1620466382410463901A024FE2402463002A085D7D2120F00006204D1662C930C050000D32C42A0D76204917463046204D1662C15C4FFFFD3480000090203030417D030208003D65D26D14626018003D6D2D2662C463A014800000A030403041BD030208003D75D034A03008003D7D3D14F3B015D27D3D24627024800000B0101040506D030D049004700000C020101030FD0305D3C601230601258011D68114700000D000103030147000013020101020AD0305D192058026813470000140201030409D0305E2824106828470000150101040505D0302440480000160101040505D03060284800001703080405C601D030240074D62085D72080066304240074630520800663062080036307D1662C2408A274D6D1663D85D71009000009D1D1662C2400613ED1662C2404A4240014EBFFFFD12400613F560080066304D160406641613D240074630510120000096204D14642004F430162052404A07463056205D1662C15E5FFFF5D246204D2462402800663065D034A030080032A630760406641613D24007463051012000009620762066205663E4F44016205917463056205240415E6FFFFD1D22408A3612CD1D3613D620748000018080C04058912D030240074D7240074630424007463052400746306240074630724007463082400746309240074630A240074630BD1D22405A6D1D22405A6663E258001D22420A4A5A9613ED1D22440A02409A72404A5240EA0D2613E2D0374D72F017463042F027463052D0474630624007463071084080009D16207D16207663E822A1104000029240082613ED162072401A0D162072401A0663E822A1104000029240082613ED162072402A0D162072402A0663E822A1104000029240082613ED162072403A0D162072403A0663E822A1104000029240082613ED162072404A0D162072404A0663E822A1104000029240082613ED162072405A0D162072405A0663E822A1104000029240082613ED162072406A0D162072406A0663E822A1104000029240082613ED162072407A0D162072407A0663E822A1104000029240082613ED162072408A0D162072408A0663E822A1104000029240082613ED162072409A0D162072409A0663E822A1104000029240082613ED16207240AA0D16207240AA0663E822A1104000029240082613ED16207240BA0D16207240BA0663E822A1104000029240082613ED16207240CA0D16207240CA0663E822A1104000029240082613ED16207240DA0D16207240DA0663E822A1104000029240082613ED16207240EA0D16207240EA0663E822A1104000029240082613ED16207240FA0D16207240FA0663E822A1104000029240082613ED37463086204746309620574630A620674630B5D1AD3620462056206D162072400A0663E24072F03461A0774D75D1A6206D362046205D162072401A0663E240C2F04461A077463065D1A62056206D36204D162072402A0663E24112D05461A077463055D1A620462056206D3D162072403A0663E24162F05461A077463045D1AD3620462056206D162072404A0663E24072F06461A0774D75D1A6206D362046205D162072405A0663E240C2D06461A077463065D1A62056206D36204D162072406A0663E24112F07461A077463055D1A620462056206D3D162072407A0663E24162F08461A077463045D1AD3620462056206D162072408A0663E24072D07461A0774D75D1A6206D362046205D162072409A0663E240C2F09461A077463065D1A62056206D36204D16207240AA0663E24112F0A461A077463055D1A620462056206D3D16207240BA0663E24162F0B461A077463045D1AD3620462056206D16207240CA0663E24072D08461A0774D75D1A6206D362046205D16207240DA0663E240C2F0C461A077463065D1A62056206D36204D16207240EA0663E24112F0D461A077463055D1A620462056206D3D16207240FA0663E24162D09461A077463045D22D3620462056206D162072401A0663E24052F0E46220774D75D226206D362046205D162072406A0663E24092F0F4622077463065D2262056206D36204D16207240BA0663E240E2D0A4622077463055D22620462056206D3D162072400A0663E24142F104622077463045D22D3620462056206D162072405A0663E24052F1146220774D75D226206D362046205D16207240AA0663E24092D0B4622077463065D2262056206D36204D16207240FA0663E240E2F124622077463055D22620462056206D3D162072404A0663E24142F134622077463045D22D3620462056206D162072409A0663E24052D0C46220774D75D226206D362046205D16207240EA0663E24092F144622077463065D2262056206D36204D162072403A0663E240E2F154622077463055D22620462056206D3D162072408A0663E24142D0D4622077463045D22D3620462056206D16207240DA0663E24052F1646220774D75D226206D362046205D162072402A0663E24092F174622077463065D2262056206D36204D162072407A0663E240E2D0E4622077463055D22620462056206D3D16207240CA0663E24142F184622077463045D1BD3620462056206D162072405A0663E24042F19461B0774D75D1B6206D362046205D162072408A0663E240B2F1A461B077463065D1B62056206D36204D16207240BA0663E24102D0F461B077463055D1B620462056206D3D16207240EA0663E24172F1B461B077463045D1BD3620462056206D162072401A0663E24042F1C461B0774D75D1B6206D362046205D162072404A0663E240B2D10461B077463065D1B62056206D36204D162072407A0663E24102F1D461B077463055D1B620462056206D3D16207240AA0663E24172F1E461B077463045D1BD3620462056206D16207240DA0663E24042D11461B0774D75D1B6206D362046205D162072400A0663E240B2F1F461B077463065D1B62056206D36204D162072403A0663E24102F20461B077463055D1B620462056206D3D162072406A0663E24172D12461B077463045D1BD3620462056206D162072409A0663E24042F21461B0774D75D1B6206D362046205D16207240CA0663E240B2F22461B077463065D1B62056206D36204D16207240FA0663E24102D13461B077463055D1B620462056206D3D162072402A0663E24172F23461B077463045D1ED3620462056206D162072400A0663E24062F24461E0774D75D1E6206D362046205D162072407A0663E240A2D14461E077463065D1E62056206D36204D16207240EA0663E240F2F25461E077463055D1E620462056206D3D162072405A0663E24152F26461E077463045D1ED3620462056206D16207240CA0663E24062D15461E0774D75D1E6206D362046205D162072403A0663E240A2F27461E077463065D1E62056206D36204D16207240AA0663E240F2F28461E077463055D1E620462056206D3D162072401A0663E24152F29461E077463045D1ED3620462056206D162072408A0663E24062D16461E0774D75D1E6206D362046205D16207240FA0663E240A2F2A461E077463065D1E62056206D36204D162072406A0663E240F2F2B461E077463055D1E620462056206D3D16207240DA0663E24152D17461E077463045D1ED3620462056206D162072404A0663E24062F2C461E0774D75D1E6206D362046205D16207240BA0663E240A2F2D461E077463065D1E62056206D36204D162072402A0663E240F2D18461E077463055D1E620462056206D3D162072409A0663E24152F2E461E07746304D36208A074D762046209A07463046205620AA07463056206620BA074630662072410A07463076207D1662C1573F7FFD3620462056206560448000019040304050DD030D1D2A5D12420D2A1A7A94800001A0307040515D0305D1FD2D1A06204A06206A06205461F02D3A04800001B0708040519D0305D1CD2D3A8D2976204A8A9D1D2620562066207461C064800001C070804051AD0305D1CD26204A8D3620497A8A9D1D2620562066207461C064800001D0708040516D0305D1CD2D3AA6204AAD1D2620562066207461C064800001E0708040517D0305D1CD3D2620497A9AAD1D2620562066207461C064800001F0101040505D0302C4C480000200101040506D030D0490047000021020101030FD0305D45601230601258031D68184700000C13010000005F5F5F5F5F5F5F0040000000';
			var reg:RegExp = new RegExp(/(\w\w)/g);
			var result:Object;
			
			bytes = new ByteArray();
			result = reg.exec(code);
			while(result != null)
			{
				bytes.writeByte(int("0x" + result[0]));
				result = reg.exec(code);
			}
		}
		
		/**
		 * 初始化加密过滤器 
		 * @param t
		 * @param finishCallback
		 * 
		 */		
		public function init(uid:String, t:int, finishCallback:Function=null):void
		{
			this.t = t;
			this.uid = uid;
			this.callback = finishCallback;
			
			var bytes2:ByteArray= new ByteArray();
			// FWS
			bytes2.writeByte(0x46);
			bytes2.writeByte(0x57);
			bytes2.writeByte(0x53);
			bytes2.writeBytes(bytes,0, bytes.length);
			
			var loader:Loader = new Loader();
			loader.contentLoaderInfo.addEventListener(Event.COMPLETE, completeHandler);
			loader.loadBytes(bytes2);
		}
		
		// 加载完成
		private function completeHandler(e:Event):void
		{
			var loaderInfo:LoaderInfo = e.target as LoaderInfo;
			
			sp = loaderInfo.content as Sprite;
			sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)] = t;
			loaderInfo.loader.unload();
			
			HttpLoader.addSendFilter(filter);
			
			if (callback != null)
			{
				callback();
				callback = null;
			}
		}
		
		/**
		 * 过滤器处理 
		 * @param url
		 * @param method
		 * @param vars
		 * 
		 */		 
		private function filter(url:String, method:String, vars:URLVariables):void
		{
			if (URLRequestMethod.POST == method)
			{
				// vars _t = t
				vars[sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f)] + sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)]] = sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)];
				// _s = ________________(t + uid)
				vars[sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f)] + sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)]] = sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)](sp[String.fromCharCode(0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f,0x5f)] + uid);
			}
		}
	}
}